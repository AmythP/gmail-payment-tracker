"""\nGmail Payment Tracker\n=====================\nAutomatically extracts payment amounts from Gmail no-reply emails\nand saves them to Excel and Google Sheets with dates\n"""\n\nimport os\nimport re\nimport base64\nfrom datetime import datetime\nfrom pathlib import Path\nimport logging\nimport json\nfrom typing import Dict, List, Optional, Tuple\nimport pandas as pd\nfrom google.auth.transport.requests import Request\nfrom google.oauth2.credentials import Credentials\nfrom google_auth_oauthlib.flow import InstalledAppFlow\nfrom googleapiclient.discovery import build\nimport gspread\nfrom google.oauth2.service_account import Credentials as ServiceCredentials\n\n# Gmail API scope\nSCOPES = ['https://www.googleapis.com/auth/gmail.readonly']\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n    handlers=[\n        logging.FileHandler('gmail_payment_tracker.log'),\n        logging.StreamHandler()\n    ]\n)\nlogger = logging.getLogger(__name__)\n\n\nclass GmailPaymentTracker:\n    \"\"\"Extract payment information from Gmail and track in Excel/Google Sheets\"\"\"\n    \n    def __init__(self, config_path: str = 'config.json'):\n        \"\"\"\n        Initialize the payment tracker\n        \n        Args:\n            config_path: Path to configuration file\n        \"\"\"\n        self.config = self._load_config(config_path)\n        self.gmail_service = None\n        self.sheets_client = None\n        self._authenticate_gmail()\n        self._authenticate_google_sheets()\n        logger.info(\"Gmail Payment Tracker initialized\")\n    \n    def _load_config(self, config_path: str) -> Dict:\n        \"\"\"Load configuration from JSON file\"\"\"\n        if Path(config_path).exists():\n            with open(config_path, 'r') as f:\n                return json.load(f)\n        return self._get_default_config()\n    \n    def _get_default_config(self) -> Dict:\n        \"\"\"Return default configuration\"\"\"\n        return {\n            'gmail': {\n                'credentials_file': 'credentials.json',\n                'token_file': 'token.json',\n                'search_query': 'from:noreply payment OR amount OR paid'\n            },\n            'google_sheets': {\n                'credentials_file': 'service_credentials.json',\n                'spreadsheet_name': 'Payment Tracker'\n            },\n            'excel': {\n                'output_directory': 'payment_data',\n                'filename': 'payment_tracker.xlsx'\n            },\n            'payment_patterns': [\n                r'\\$[\\d,]+\\\\.\\\\d{2}',\n                r'₹[\\d,]+\\\\.?\\\\d*',\n                r'Rs\\\\.?\\\\s*[\\d,]+\\\\.?\\\\d*',\n                r'INR\\\\s*[\\d,]+\\\\.?\\\\d*',\n                r'USD\\\\s*[\\d,]+\\\\.\\\\d{2}',\n                r'amount\\\\s*:?\\\\s*[\\d,]+\\\\.?\\\\d*'\n            ]\n        }\n    \n    def _authenticate_gmail(self):\n        \"\"\"Authenticate with Gmail API\"\"\"\n        try:\n            creds = None\n            token_file = self.config['gmail']['token_file']\n            creds_file = self.config['gmail']['credentials_file']\n            \n            if Path(token_file).exists():\n                creds = Credentials.from_authorized_user_file(token_file, SCOPES)\n            \n            if not creds or not creds.valid:\n                if creds and creds.expired and creds.refresh_token:\n                    creds.refresh(Request())\n                else:\n                    if Path(creds_file).exists():\n                        flow = InstalledAppFlow.from_client_secrets_file(\n                            creds_file, SCOPES)\n                        creds = flow.run_local_server(port=0)\n                    else:\n                        logger.warning(f\"Gmail credentials file not found: {creds_file}\")\n                        return\n                \n                with open(token_file, 'w') as token:\n                    token.write(creds.to_json())\n            \n            self.gmail_service = build('gmail', 'v1', credentials=creds)\n            logger.info(\"Gmail authentication successful\")\n            \n        except Exception as e:\n            logger.error(f\"Gmail authentication failed: {e}\")\n    \n    def _authenticate_google_sheets(self):\n        \"\"\"Authenticate with Google Sheets API\"\"\"\n        try:\n            creds_file = self.config['google_sheets']['credentials_file']\n            if Path(creds_file).exists():\n                SCOPES = ['https://www.googleapis.com/auth/spreadsheets']\n                creds = ServiceCredentials.from_service_account_file(\n                    creds_file, scopes=SCOPES)\n                self.sheets_client = gspread.authorize(creds)\n                logger.info(\"Google Sheets authentication successful\")\n            else:\n                logger.warning(f\"Google Sheets credentials file not found: {creds_file}\")\n        except Exception as e:\n            logger.error(f\"Google Sheets authentication failed: {e}\")\n    \n    def search_payment_emails(self, max_results: int = 100) -> List[Dict]:\n        \"\"\"\n        Search for payment-related emails\n        \n        Args:\n            max_results: Maximum number of emails to retrieve\n            \n        Returns:\n            List of email data dictionaries\n        \"\"\"\n        if not self.gmail_service:\n            logger.error(\"Gmail service not authenticated\")\n            return []\n        \n        try:\n            query = self.config['gmail']['search_query']\n            results = self.gmail_service.users().messages().list(\n                userId='me',\n                q=query,\n                maxResults=max_results\n            ).execute()\n            \n            messages = results.get('messages', [])\n            logger.info(f\"Found {len(messages)} payment-related emails\")\n            \n            payment_data = []\n            for msg in messages:\n                email_data = self._extract_payment_from_email(msg['id'])\n                if email_data:\n                    payment_data.append(email_data)\n            \n            return payment_data\n            \n        except Exception as e:\n            logger.error(f\"Failed to search emails: {e}\")\n            return []\n    \n    def _extract_payment_from_email(self, message_id: str) -> Optional[Dict]:\n        \"\"\"\n        Extract payment information from a single email\n        \n        Args:\n            message_id: Gmail message ID\n            \n        Returns:\n            Dictionary with payment information or None\n        \"\"\"\n        try:\n            message = self.gmail_service.users().messages().get(\n                userId='me',\n                id=message_id,\n                format='full'\n            ).execute()\n            \n            # Extract headers\n            headers = message['payload']['headers']\n            sender = next((h['value'] for h in headers if h['name'] == 'From'), 'Unknown')\n            subject = next((h['value'] for h in headers if h['name'] == 'Subject'), 'No Subject')\n            date_str = next((h['value'] for h in headers if h['name'] == 'Date'), '')\n            \n            # Parse date\n            received_date = self._parse_email_date(date_str)\n            \n            # Extract body\n            body = self._get_email_body(message)\n            \n            # Extract payment amounts\n            amounts = self._extract_amounts(body)\n            \n            if amounts:\n                return {\n                    'date': received_date,\n                    'sender': sender,\n                    'subject': subject,\n                    'amount': amounts[0],  # Take first amount found\n                    'currency': self._detect_currency(amounts[0]),\n                    'email_body_preview': body[:100]\n                }\n            \n            return None\n            \n        except Exception as e:\n            logger.error(f\"Failed to extract payment from email {message_id}: {e}\")\n            return None\n    \n    def _get_email_body(self, message: Dict) -> str:\n        \"\"\"Extract email body text\"\"\"\n        try:\n            if 'parts' in message['payload']:\n                parts = message['payload']['parts']\n                for part in parts:\n                    if part['mimeType'] == 'text/plain':\n                        data = part['body']['data']\n                        return base64.urlsafe_b64decode(data).decode('utf-8')\n            elif 'body' in message['payload']:\n                data = message['payload']['body']['data']\n                return base64.urlsafe_b64decode(data).decode('utf-8')\n            return \"\"\n        except Exception as e:\n            logger.error(f\"Failed to extract email body: {e}\")\n            return \"\"\n    \n    def _extract_amounts(self, text: str) -> List[str]:\n        \"\"\"Extract payment amounts from text\"\"\"\n        amounts = []\n        for pattern in self.config['payment_patterns']:\n            matches = re.findall(pattern, text, re.IGNORECASE)\n            amounts.extend(matches)\n        return amounts\n    \n    def _detect_currency(self, amount_str: str) -> str:\n        \"\"\"Detect currency from amount string\"\"\"\n        if '$' in amount_str or 'USD' in amount_str:\n            return 'USD'\n        elif '₹' in amount_str or 'Rs' in amount_str or 'INR' in amount_str:\n            return 'INR'\n        return 'Unknown'\n    \n    def _parse_email_date(self, date_str: str) -> str:\n        \"\"\"Parse email date string to standard format\"\"\"\n        try:\n            from email.utils import parsedate_to_datetime\n            dt = parsedate_to_datetime(date_str)\n            return dt.strftime('%Y-%m-%d %H:%M:%S')\n        except:\n            return datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    \n    def save_to_excel(self, payment_data: List[Dict]) -> str:\n        \"\"\"\n        Save payment data to Excel file\n        \n        Args:\n            payment_data: List of payment dictionaries\n            \n        Returns:\n            Path to created Excel file\n        \"\"\"\n        try:\n            # Create output directory\n            output_dir = Path(self.config['excel']['output_directory'])\n            output_dir.mkdir(parents=True, exist_ok=True)\n            \n            # Create DataFrame\n            df = pd.DataFrame(payment_data)\n            \n            # Generate filepath\n            filename = self.config['excel']['filename']\n            filepath = output_dir / filename\n            \n            # Save to Excel\n            df.to_excel(filepath, index=False)\n            logger.info(f\"Payment data saved to Excel: {filepath}\")\n            return str(filepath)\n            \n        except Exception as e:\n            logger.error(f\"Failed to save to Excel: {e}\")\n            return \"\"\n    \n    def save_to_google_sheets(self, payment_data: List[Dict]) -> bool:\n        \"\"\"\n        Save payment data to Google Sheets\n        \n        Args:\n            payment_data: List of payment dictionaries\n            \n        Returns:\n            True if successful, False otherwise\n        \"\"\"\n        try:\n            if not self.sheets_client:\n                logger.error(\"Google Sheets client not authenticated\")\n                return False\n            \n            sheet_name = self.config['google_sheets']['spreadsheet_name']\n            \n            # Open or create spreadsheet\n            try:\n                spreadsheet = self.sheets_client.open(sheet_name)\n            except gspread.SpreadsheetNotFound:\n                spreadsheet = self.sheets_client.create(sheet_name)\n            \n            # Get or create worksheet\n            try:\n                worksheet = spreadsheet.worksheet('Payments')\n                worksheet.clear()\n            except gspread.WorksheetNotFound:\n                worksheet = spreadsheet.add_worksheet(title='Payments', rows=1000, cols=10)\n            \n            # Create DataFrame and update sheet\n            df = pd.DataFrame(payment_data)\n            worksheet.update([df.columns.values.tolist()] + df.values.tolist())\n            \n            # Format header\n            worksheet.format('A1:F1', {\n                'textFormat': {'bold': True},\n                'backgroundColor': {'red': 0.2, 'green': 0.7, 'blue': 0.3}\n            })\n            \n            logger.info(f\"Payment data saved to Google Sheets: {sheet_name}\")\n            return True\n            \n        except Exception as e:\n            logger.error(f\"Failed to save to Google Sheets: {e}\")\n            return False\n    \n    def run_tracker(self, max_emails: int = 100):\n        \"\"\"Run the complete payment tracking workflow\"\"\"\n        logger.info(\"Starting payment tracking\")\n        print(\"\\nGmail Payment Tracker\")\n        print(\"=\" * 50)\n        \n        # Search for payment emails\n        print(\"\\nSearching for payment emails...\")\n        payment_data = self.search_payment_emails(max_emails)\n        \n        if not payment_data:\n            print(\"No payment emails found.\")\n            return\n        \n        print(f\"Found {len(payment_data)} payments\\n\")\n        \n        # Display sample\n        print(\"Sample payments:\")\n        print(\"-\" * 50)\n        for payment in payment_data[:5]:\n            print(f\"Date: {payment['date']}\")\n            print(f\"Amount: {payment['amount']} {payment['currency']}\")\n            print(f\"From: {payment['sender']}\")\n            print(\"-\" * 50)\n        \n        # Save to Excel\n        print(\"\\nSaving to Excel...\")\n        excel_path = self.save_to_excel(payment_data)\n        if excel_path:\n            print(f\"✓ Saved to: {excel_path}\")\n        \n        # Save to Google Sheets\n        print(\"\\nSaving to Google Sheets...\")\n        sheets_success = self.save_to_google_sheets(payment_data)\n        if sheets_success:\n            print(f\"✓ Saved to Google Sheets\")\n        \n        print(\"\\n\" + \"=\" * 50)\n        print(f\"Tracking complete! Found {len(payment_data)} payments\")\n\n\ndef main():\n    \"\"\"Main execution function\"\"\"\n    tracker = GmailPaymentTracker()\n    tracker.run_tracker(max_emails=100)\n\n\nif __name__ == \"__main__\":\n    main()\n